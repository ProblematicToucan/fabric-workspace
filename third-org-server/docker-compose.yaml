# =============================================================================
# Org3 peer — single service, connects to existing network (learning)
# =============================================================================
#
# LEARNING: This Compose file starts only peer0.org3. It does NOT start an
# orderer; the channel uses the parent's orderer. Key points:
#
#   - network fabric_workspace (external): same as parent so this peer can
#     reach orderer.example.com and peer0.org1.example.com.
#   - Port 8051:7051 so the host can reach Org3 peer without clashing with
#     peer0.org1 (7051).
#   - Crypto and peercfg come from this dir and parent; ledger lives in a
#     named volume so it persists across restarts.
#
# Run from third-org-server. Prereq: ./run.sh generate and parent network up.
# =============================================================================

volumes:
  peer0.org3.example.com:   # Ledger and chaincode data for this peer

networks:
  default:
    name: fabric_workspace  # Must match parent docker-compose network
    external: true

services:
  peer0.org3.example.com:
    container_name: peer0.org3.example.com
    image: hyperledger/fabric-peer:latest
    environment:
      # Peer config file (core.yaml) from parent peercfg
      - FABRIC_CFG_PATH=/etc/hyperledger/peercfg
      - FABRIC_LOGGING_SPEC=INFO
      # TLS: server cert and key from cryptogen output
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=false
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      # Identity and listen addresses
      - CORE_PEER_ID=peer0.org3.example.com
      - CORE_PEER_ADDRESS=peer0.org3.example.com:7051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:7051
      - CORE_PEER_CHAINCODEADDRESS=peer0.org3.example.com:7052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052
      # Gossip: bootstrap to an existing peer so we discover the channel
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.example.com:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org3.example.com:7051
      # MSP: Org3 identity (msp dir from cryptogen)
      - CORE_PEER_LOCALMSPID=Org3MSP
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp
      - CORE_OPERATIONS_LISTENADDRESS=peer0.org3.example.com:9444
      - CORE_METRICS_PROVIDER=prometheus
    volumes:
      # Peer identity + TLS (from generate_org3_crypto.sh)
      - ./organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com:/etc/hyperledger/fabric
      # core.yaml from parent (shared peer config)
      - ../peercfg:/etc/hyperledger/peercfg
      # Ledger and chaincode persistence
      - peer0.org3.example.com:/var/hyperledger/production
    working_dir: /root
    command: peer node start
    ports:
      - 8051:7051   # Host:Container — peer gRPC for CLI and gossip
      - 8052:9444   # Operations (optional)
    networks:
      - default
